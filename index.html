<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meseta Inclinada 2025</title>
  <link rel="stylesheet" href="./libs/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .layout { display: grid; grid-template-columns: 310px 1fr; height: 100%; }
    .sidebar { border-right: 1px solid #e5e7eb; padding: 12px; overflow: auto; }
    .sidebar h1 { font-size: 18px; margin: 0 0 8px; }
    .sidebar .muted { color: #6b7280; font-size: 12px; margin-bottom: 12px; }
    .filters { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin-bottom: 12px; }
    .filter-title { font-weight: 600; margin-bottom: 6px; }
    .participants { max-height: 160px; overflow: auto; }
    .actions { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    button, .button-link {
      appearance: none; border: 1px solid #d1d5db; background: white; padding: 6px 10px;
      border-radius: 8px; cursor: pointer; font-size: 14px;
    }
    button:hover, .button-link:hover { background: #f3f4f6; }
    .routes { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; }
    .route-item { border-bottom: 1px dashed #e5e7eb; padding: 8px 4px; }
    .route-item:last-child { border-bottom: none; }
    .route-item-title { font-weight: 600; font-size: 14px; }
    .route-item-meta { color: #6b7280; font-size: 12px; }
    #map { height: 100%; width: 100%; }
    .footer { color: #9ca3af; font-size: 11px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1>La meseta inclinada</h1>
      <div class="muted">Rutas de Montaña 2025</div>
      <div class="filters">
        <div class="filter-title">Filtrar por persona</div>
        <div class="participants" id="participants"></div>
        <div class="actions">
          <button id="clearFilters">Quitar filtros</button>
          <a class="button-link" href="#" id="fitAll">Ver todas</a>
        </div>
      </div>
      <div class="routes" id="routes"></div>
      <div class="footer">Diseñado por Daniel Fernández utilizando openstreetmap y leaflet. ¡Comparte el código fuente!</div>
    </aside>
    <main id="map"></main>
  </div>

  <script src="./libs/leaflet.js"></script>
  <script src="./libs/gpx.min.js"></script>
  <script>
    const map = L.map('map', { zoomControl: true }).setView([40.4168, -3.7038], 6);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contrib.'
    }).addTo(map);

    const layersById = new Map(); // id -> { gpxLayer, meta, bounds }
    let allBounds = null;

    function colorForIndex(i) {
      const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
      return palette[i % palette.length];
    }

    function intersects(a, b) {
      return a.some(x => b.includes(x));
    }

    function updateVisibility() {
      const checked = [...document.querySelectorAll('input[name="person"]:checked')].map(i => i.value);
      layersById.forEach(({ gpxLayer, meta }) => {
        const show = checked.length === 0 ? true : intersects(meta.participantes, checked);
        if (show) {
          if (!map.hasLayer(gpxLayer)) gpxLayer.addTo(map);
        } else {
          if (map.hasLayer(gpxLayer)) map.removeLayer(gpxLayer);
        }
      });
    }

    function fitAllBounds() {
      if (allBounds) {
        map.fitBounds(allBounds.pad(0.1));
      } else {
        map.setView([40.4168, -3.7038], 6);
      }
    }

    // Build UI entries
    function addRouteToList(id, meta) {
      const routesEl = document.getElementById('routes');
      const item = document.createElement('div');
      item.className = 'route-item';

      const title = document.createElement('div');
      title.className = 'route-item-title';
      title.textContent = meta.nombre;
      item.appendChild(title);

      const metaEl = document.createElement('div');
      metaEl.className = 'route-item-meta';
      const participantes = meta.participantes.join(', ');
      metaEl.textContent = `${meta.fecha || ''} — ${participantes}`.trim();
      item.appendChild(metaEl);

      const actions = document.createElement('div');
      actions.className = 'actions';
      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'Ver ruta';
      viewBtn.addEventListener('click', () => {
        const entry = layersById.get(id);
        if (entry && entry.bounds) {
          map.fitBounds(entry.bounds.pad(0.1));
        } else {
          // Wait for load event if not ready yet
          const e2 = layersById.get(id);
          if (e2) {
            e2.gpxLayer.once('loaded', () => {
              if (e2.bounds) map.fitBounds(e2.bounds.pad(0.1));
            });
          }
        }
      });
      actions.appendChild(viewBtn);
      item.appendChild(actions);

      routesEl.appendChild(item);
    }

    function buildParticipantsFilter(people) {
      const container = document.getElementById('participants');
      container.innerHTML = '';
      const sorted = Array.from(people).sort((a,b) => a.localeCompare(b));
      sorted.forEach(name => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.margin = '4px 0';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.name = 'person';
        input.value = name;
        input.addEventListener('change', updateVisibility);
        label.appendChild(input);
        const span = document.createElement('span');
        span.textContent = name;
        label.appendChild(span);
        container.appendChild(label);
      });
    }

    document.getElementById('clearFilters').addEventListener('click', () => {
      document.querySelectorAll('input[name="person"]').forEach(i => i.checked = false);
      updateVisibility();
    });

    document.getElementById('fitAll').addEventListener('click', (e) => {
      e.preventDefault();
      fitAllBounds();
    });

    // Load metadata and GPX layers
    fetch('data.json')
      .then(r => r.json())
      .then(data => {
        const people = new Set();
        const boundsAccumulator = [];

        data.forEach((meta, idx) => {
          const id = meta.id || meta.archivo;
          meta.participantes.forEach(p => people.add(p));
          addRouteToList(id, meta);

          const gpx = new L.GPX('gpx/' + meta.archivo, {
            async: true,
            polyline_options: {
              color: colorForIndex(idx),
              weight: 4,
              opacity: 0.9
            },
            marker_options: {
              startIconUrl: 'https://unpkg.com/leaflet-gpx@1.7.0/pin-icon-start.png',
              endIconUrl: 'https://unpkg.com/leaflet-gpx@1.7.0/pin-icon-end.png',
              shadowUrl: 'https://unpkg.com/leaflet-gpx@1.7.0/pin-shadow.png'
            }
          });

            gpx.on('loaded', function (e) {
                const b = e.target.getBounds();
                layersById.get(id).bounds = b;
                boundsAccumulator.push(b);

                // Actualizar bounds global
                let union = boundsAccumulator[0];
                for (let i = 1; i < boundsAccumulator.length; i++) {
                    union = union.extend(boundsAccumulator[i]);
                }
                allBounds = union;
                if (idx === 0) {
                    map.fitBounds(b.pad(0.1));
                }

                // Datos principales
                const distanciaKm = (e.target.get_distance() / 1000).toFixed(2);
                const desnivelM = e.target.get_elevation_gain().toFixed(0);

                // Duración con validación
                let durTotalS = e.target.get_total_time();
                let durMovS = e.target.get_moving_time();

                // Función para formatear duración en h/min
                function formatDuracion(segundos) {
                    if (!segundos || segundos <= 0) return 'N/A';
                    const h = Math.floor(segundos / 3600);
                    const m = Math.round((segundos % 3600) / 60);
                    return h > 0 ? `${h} h ${m} min` : `${m} min`;
                }

                // Validar valores absurdos (>24h total o >24h en movimiento)
                const maxSegundosRazonable = 24 * 3600;
                if (durTotalS > maxSegundosRazonable || durMovS > maxSegundosRazonable) {
                    // Estimar duración en base a distancia y velocidad media
                    const velocidadMediaKmH = 4.5; // km/h, ajustar según tipo de ruta
                    const durH = distanciaKm / velocidadMediaKmH;
                    durTotalS = durH * 3600;
                    durMovS = durH * 3600;
                }

                const duracionTotalStr = formatDuracion(durTotalS);
                const duracionMovStr = formatDuracion(durMovS);

                // Construir popup
                const popupHtml = `
        <div>
            <div style="font-weight:600;margin-bottom:4px;">${meta.nombre}</div>
            <div style="font-size:12px;color:#6b7280;">${meta.fecha || ''}</div>
            <div style="margin:6px 0;">${meta.descripcion || ''}</div>
            <div style="font-size:12px;"><b>Participantes:</b> ${meta.participantes.join(', ')}</div>
            <div style="font-size:12px;"><b>Longitud:</b> ${distanciaKm} km</div>
            <div style="font-size:12px;"><b>Desnivel:</b> ${desnivelM} m</div>
            <div style="font-size:12px;"><b>Duración total:</b> ${duracionTotalStr}</div>
            ${meta.relive ? `<div style="margin-top:4px;"><a href="${meta.relive}" target="_blank">Ver en Relive</a></div>` : ''}
        </div>
    `;

                e.target.bindPopup(popupHtml);
            });



          gpx.on('error', function() {
            console.error('Error cargando GPX', meta.archivo);
          });

          layersById.set(id, { gpxLayer: gpx, meta, bounds: null });
          gpx.addTo(map);
        });

        buildParticipantsFilter(people);
        updateVisibility();
      })
      .catch(err => {
        console.error('No se pudo cargar data.json', err);
        alert('No se pudo cargar data.json. Asegúrate de servir los archivos vía HTTP (GitHub Pages o un servidor local).');
      });
  </script>
</body>
</html>
